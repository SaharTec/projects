<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>מערכת סידור שולחנות</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap');
    body { font-family: 'Rubik', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    const Upload = () => (
      <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
      </svg>
    );

    const Users = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
    );

    const CheckCircle = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );

    const FileSpreadsheet = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
    );

    const Settings = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    );

    const ArrowRight = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
      </svg>
    );

    const AlertCircle = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );

    function App() {
      const [knightTableCount, setKnightTableCount] = useState(0);
      const [knightGroup, setKnightGroup] = useState('');
      const [tableType, setTableType] = useState('regular');
      const [seatCount, setSeatCount] = useState(10);
      const [file, setFile] = useState(null);
      const [isDragging, setIsDragging] = useState(false);
      const [status, setStatus] = useState('idle');
      const [resultMessage, setResultMessage] = useState('');
      const [downloadUrl, setDownloadUrl] = useState('');
      const [analysisData, setAnalysisData] = useState(null);
      const [parentPreference, setParentPreference] = useState('together');
      const [showParentDecision, setShowParentDecision] = useState(false);
      const fileInputRef = useRef(null);

      const API_URL = 'http://localhost:5000';

      const handleTableTypeChange = (type) => {
        setTableType(type);
        if (type === 'knight') {
          setSeatCount(22);
        } else {
          setSeatCount(10);
        }
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        setIsDragging(true);
      };

      const handleDragLeave = () => {
        setIsDragging(false);
      };

      const handleDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);
        const droppedFile = e.dataTransfer.files[0];
        validateAndSetFile(droppedFile);
      };

      const handleFileChange = (e) => {
        const selectedFile = e.target.files[0];
        validateAndSetFile(selectedFile);
      };

      const validateAndSetFile = async (selectedFile) => {
        if (selectedFile) {
          const fileType = selectedFile.name.split('.').pop().toLowerCase();
          if (fileType === 'xlsx' || fileType === 'xls') {
            setFile(selectedFile);
            setStatus('idle');
            setResultMessage('');
            setDownloadUrl('');
            
            // Analyze file for parent groups
            await analyzeFile(selectedFile);
          } else {
            alert('אנא בחר קובץ אקסל תקין (xlsx, xls)');
          }
        }
      };

      const analyzeFile = async (fileToAnalyze) => {
        const formData = new FormData();
        formData.append('file', fileToAnalyze);

        try {
          const response = await fetch(`${API_URL}/api/analyze`, {
            method: 'POST',
            body: formData
          });

          const result = await response.json();
          
          if (result.success) {
            setAnalysisData(result.analysis);
            
            // Check if we need to show parent decision dialog
            const brideParents = result.analysis.bride.parent_info;
            const groomParents = result.analysis.groom.parent_info;
            
            if ((brideParents && brideParents.needs_decision) || 
                (groomParents && groomParents.needs_decision)) {
              setShowParentDecision(true);
            } else {
              setShowParentDecision(false);
            }
          }
        } catch (error) {
          console.error('Error analyzing file:', error);
        }
      };

      const handleSubmit = async () => {
        if (!file) {
          alert('אנא העלה קובץ אקסל לפני שתמשיך');
          return;
        }

        setStatus('uploading');
        setResultMessage('');

        const formData = new FormData();
        formData.append('file', file);
        formData.append('table_type', tableType);
        formData.append('seats_per_table', seatCount);
        formData.append('knight_table_count', knightTableCount);
        formData.append('knight_group', knightGroup);
        formData.append('parent_preference', parentPreference);

        try {
          const response = await fetch(`${API_URL}/api/process`, {
            method: 'POST',
            body: formData
          });

          const result = await response.json();
          
          if (result.success) {
            setStatus('success');
            setDownloadUrl(`${API_URL}${result.download_url}`);
            setResultMessage(`
              עובד בהצלחה! נוצרו ${result.stats.bride_tables} שולחנות לצד הכלה 
              ו-${result.stats.groom_tables} שולחנות לצד החתן.
            `);
          } else {
            setStatus('error');
            alert('שגיאה: ' + result.error);
          }
        } catch (error) {
          setStatus('error');
          alert('שגיאה בתקשורת עם השרת. וודא ש-backend.py רץ על http://localhost:5000');
          console.error(error);
        }
      };

      const handleDownload = () => {
        if (downloadUrl) {
          window.open(downloadUrl, '_blank');
        }
      };

      return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 text-slate-800">
          <div className="max-w-2xl w-full bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100">
            
            <div className="bg-gradient-to-l from-blue-600 to-indigo-700 p-8 text-white relative overflow-hidden">
              <div className="absolute top-0 left-0 w-32 h-32 bg-white opacity-10 rounded-full -translate-x-10 -translate-y-10"></div>
              <h1 className="text-3xl font-bold mb-2 flex items-center gap-3">
                <Settings className="w-8 h-8" />
                מערכת סידור שולחנות
              </h1>
              <p className="text-blue-100 opacity-90">
                הגדרת פרמטרים וסנכרון נתונים לעיבוד אוטומטי
              </p>
            </div>

            <div className="p-8 space-y-8">

              {/* Parent Groups Decision Alert */}
              {showParentDecision && analysisData && (
                <div className="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6">
                  <div className="flex items-start gap-3 mb-4">
                    <AlertCircle className="w-6 h-6 text-yellow-600 shrink-0 mt-1" />
                    <div className="flex-1">
                      <h3 className="font-bold text-yellow-800 text-lg mb-2">
                        נדרשת החלטה לגבי משפחה אבא ואמא
                      </h3>
                      
                      {analysisData.bride.parent_info && analysisData.bride.parent_info.needs_decision && (
                        <div className="mb-3 text-sm text-yellow-800">
                          <strong>צד הכלה:</strong> משפחה אבא ({analysisData.bride.parent_info.aba_count} מוזמנים) 
                          + משפחה אמא ({analysisData.bride.parent_info.ima_count} מוזמנים) 
                          = סה"כ {analysisData.bride.parent_info.total} מוזמנים
                        </div>
                      )}
                      
                      {analysisData.groom.parent_info && analysisData.groom.parent_info.needs_decision && (
                        <div className="mb-3 text-sm text-yellow-800">
                          <strong>צד החתן:</strong> משפחה אבא ({analysisData.groom.parent_info.aba_count} מוזמנים) 
                          + משפחה אמא ({analysisData.groom.parent_info.ima_count} מוזמנים) 
                          = סה"כ {analysisData.groom.parent_info.total} מוזמנים
                        </div>
                      )}

                      <p className="text-sm text-yellow-700 mb-4">
                        הכמות גדולה מ-12 וקטנה מ-22. איך תרצה לסדר אותם?
                      </p>
                    </div>
                  </div>

                  <div className="space-y-2">
                    <label className="flex items-center gap-3 p-3 bg-white rounded-lg border-2 border-yellow-200 cursor-pointer hover:bg-yellow-50">
                      <input
                        type="radio"
                        name="parentPreference"
                        value="knight"
                        checked={parentPreference === 'knight'}
                        onChange={(e) => setParentPreference(e.target.value)}
                        className="w-4 h-4"
                      />
                      <span className="font-medium">שולחן אביר אחד (22 מקומות)</span>
                    </label>

                    <label className="flex items-center gap-3 p-3 bg-white rounded-lg border-2 border-yellow-200 cursor-pointer hover:bg-yellow-50">
                      <input
                        type="radio"
                        name="parentPreference"
                        value="separate"
                        checked={parentPreference === 'separate'}
                        onChange={(e) => setParentPreference(e.target.value)}
                        className="w-4 h-4"
                      />
                      <span className="font-medium">2 שולחנות רגילים נפרדים</span>
                    </label>
                  </div>
                </div>
              )}

              <section className={`transition-all duration-300 ${tableType === 'regular' ? 'opacity-100' : 'opacity-50 grayscale pointer-events-none'}`}>
                 <h2 className="text-lg font-semibold text-gray-700 mb-4">כמות אנשים בשולחן רגיל</h2>
                 <div className="bg-gray-50 p-6 rounded-xl border border-gray-200">
                   <div className="flex justify-between mb-2">
                     <span className="text-sm font-medium text-gray-500">10 אנשים</span>
                     <span className="text-sm font-medium text-gray-500">12 אנשים</span>
                   </div>
                   <input
                     type="range"
                     min="10"
                     max="12"
                     step="1"
                     disabled={tableType !== 'regular'}
                     value={seatCount}
                     onChange={(e) => setSeatCount(parseInt(e.target.value))}
                     className="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                   />
                   <div className="mt-4 text-center">
                     <span className="inline-block px-4 py-2 bg-white rounded-lg shadow-sm border border-gray-200 font-bold text-blue-600">
                       {seatCount} מוזמנים לשולחן
                     </span>
                   </div>
                 </div>
              </section>

              <section className="bg-purple-50 border border-purple-200 rounded-xl p-6">
                <h2 className="text-lg font-semibold text-purple-700 mb-4">
                  שולחנות אביר – הגדרות מתקדמות
                </h2>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      מספר שולחנות אביר
                    </label>
                    <input
                      type="number"
                      min="0"
                      value={knightTableCount}
                      onChange={(e) => setKnightTableCount(parseInt(e.target.value) || 0)}
                      className="w-full p-2 border rounded-lg"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      קרבה לשיבוץ בשולחן אביר
                    </label>
                    <input
                      type="text"
                      placeholder="לדוגמה: משפחה"
                      value={knightGroup}
                      onChange={(e) => setKnightGroup(e.target.value)}
                      className="w-full p-2 border rounded-lg"
                    />
                  </div>
                </div>

                <p className="text-xs text-purple-700 mt-3">
                  אם מספר שולחנות אביר הוא 0 – האפשרות מבוטלת
                </p>
              </section>

              <section>
                <h2 className="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
                  <FileSpreadsheet className="w-5 h-5 text-green-600" />
                  העלאת קובץ נתונים (Excel)
                </h2>
                
                <div
                  onDragOver={handleDragOver}
                  onDragLeave={handleDragLeave}
                  onDrop={handleDrop}
                  onClick={() => fileInputRef.current?.click()}
                  className={`
                    relative border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-all duration-200
                    flex flex-col items-center justify-center gap-3
                    ${isDragging 
                      ? 'border-blue-500 bg-blue-50' 
                      : file 
                        ? 'border-green-500 bg-green-50' 
                        : 'border-gray-300 hover:border-gray-400 hover:bg-gray-50'
                    }
                  `}
                >
                  <input 
                    type="file" 
                    ref={fileInputRef} 
                    onChange={handleFileChange} 
                    className="hidden" 
                    accept=".xlsx,.xls"
                  />
                  
                  {file ? (
                    <>
                      <FileSpreadsheet className="w-12 h-12 text-green-600" />
                      <div>
                        <div className="font-bold text-gray-800">{file.name}</div>
                        <div className="text-sm text-green-700">הקובץ נטען בהצלחה</div>
                      </div>
                      <button 
                        onClick={(e) => { e.stopPropagation(); setFile(null); setShowParentDecision(false); }}
                        className="absolute top-2 left-2 text-xs text-red-500 hover:text-red-700 font-medium px-2 py-1 bg-white rounded shadow-sm"
                      >
                        הסר
                      </button>
                    </>
                  ) : (
                    <>
                      <Upload />
                      <div className="text-gray-600">
                        <span className="font-bold text-blue-600 hover:underline">לחץ להעלאה</span> או גרור קובץ לכאן
                      </div>
                      <div className="text-xs text-gray-400">תומך בקבצי Excel (.xlsx, .xls)</div>
                    </>
                  )}
                </div>
              </section>

              <div className="pt-4 border-t border-gray-100">
                 <button
                   onClick={handleSubmit}
                   disabled={!file || status === 'uploading' || status === 'success'}
                   className={`
                     w-full py-4 rounded-xl text-lg font-bold shadow-lg transition-all duration-200 flex items-center justify-center gap-2
                     ${status === 'success' 
                       ? 'bg-green-600 text-white cursor-default'
                       : !file 
                         ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                         : status === 'uploading'
                           ? 'bg-blue-800 text-white cursor-wait'
                           : 'bg-blue-600 hover:bg-blue-700 text-white hover:shadow-xl hover:-translate-y-1'
                     }
                   `}
                 >
                   {status === 'uploading' ? (
                     <>מעבד נתונים...</>
                   ) : status === 'success' ? (
                     <>
                       <CheckCircle className="w-6 h-6" />
                       הנתונים נשלחו בהצלחה!
                     </>
                   ) : (
                     <>
                       התחל סנכרון ועיבוד
                       <ArrowRight className="w-5 h-5" />
                     </>
                   )}
                 </button>
                 
                 {status === 'success' && (
                    <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                       <div className="flex items-start gap-3">
                         <CheckCircle className="w-5 h-5 text-green-600 shrink-0 mt-0.5" />
                         <div className="flex-1">
                            <h4 className="font-bold text-green-800">התהליך הסתיים בהצלחה!</h4>
                            <p className="text-sm text-green-700 mt-1">{resultMessage}</p>
                         </div>
                       </div>
                       <button
                         onClick={handleDownload}
                         className="mt-3 w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold transition-colors"
                       >
                         הורד קובץ תוצאות
                       </button>
                    </div>
                 )}

                 {status === 'error' && (
                    <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                       <p className="text-sm text-red-700">
                         ⚠️ אירעה שגיאה. וודא שהשרת רץ (backend.py) ושהקובץ תקין.
                       </p>
                    </div>
                 )}
              </div>

            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>